/*!
 * decj Framework---eases your daily web frontend dev with declarative prograrmming
 * https://code.google.com/p/decj
 *
 * Copyright(C) 2013 Viscent Huang (viscent.huang@gmail.com)
 *
 */
;
define(["jquery"],function(e){function a(k){if(window.console){console.log(k)}else{e("#message").val(e("#message").val()+"\n\r"+k)
}}function c(k){this.cfg=k;this._pendings=[];e.extend(this._pendings,k.url);this._loadState={};
this._timerId={}}c.LOADING=0;c.DONE=1;c.FAILED=2;var g={},h=[],j=function(){};c.prototype={_externalURLs:[],_cssLoadClue:{},_cssAjaxLoaded:function(p,q,o,l,n){this._loadState[l]=c.DONE;
var m=document.createTextNode(p);var k=document.createElement("STYLE");k.setAttribute("_ownerModule",n);
k.appendChild(m);e("head").append(k)},_cssAjaxFailed:function(){var k=arguments[arguments.length-1];
this._loadState[k]=c.FAILED},crossDomainCSSLoadClue:function(k){var l=k.substring(k.lastIndexOf("/")+1);
l=l.substr(0,l.indexOf(".css"));return l+"-Clue"},_loadCSS:function(m){if(0==m.length){return
}var k=m.pop();if(i(k)){var n=document.createElement("link");n.rel="stylesheet";n.setAttribute("_loadTime",String(new Date().getTime()));
n.setAttribute("_ownerModule",this.cfg.ownerModule);e("head")[0].appendChild(n);this._loadState[k]=c.LOADING;
n.href=k;var l;if(k.indexOf("#")>1){l=k.substring(k.indexOf("#")+1)+"-Clue"}else{l=(this.cfg.crossDomainCSSLoadClue||this.crossDomainCSSLoadClue).apply(this,[k])
}e("<span id='"+l+"' width='0px' height='0px'></span>").appendTo(document.body);this._cssLoadClue[k]=l;
this._externalURLs.push(k)}else{e.get(k).done(this._cssAjaxLoaded.transform([k,this.cfg.ownerModule],this)).fail(this._cssAjaxFailed.transform(k,this))
}},_detectSingle:function(k){if(e.inArray(k,this._externalURLs)<0){return}var m=this._loadState,l=this._cssLoadClue[k];
if("none"==e("#"+l).css("display")){m[k]=c.DONE;e("#"+l).remove()}},_doDetect:function(){var t=this.cfg,l=new Date().getTime(),q=this._pendings,s=[],v=this._loadState,u=t.url;
if(parseInt((l-this._loadTime)/1000)>=t.timeOut){clearInterval(this._timerId);var m=[];
for(var p=u.length-1,k;p>=0;p--){k=u[p];if(v[k]!=c.DONE){v[k]=c.FAILED;m.push(k)}}if(m.length>0){t.fail(m,this._loadTime)
}else{t.success(t.url,this._loadTime)}t.always(t.url,this._loadTime);return}var r=q.length;
for(var p=0,k;p<r;p++){k=q[p];this._detectSingle(k);if(v[k]!=c.DONE){s.push(k)}}this._pendings=s;
if(0==r){clearInterval(this._timerId);var n=c.DONE;var o=t.url.length;for(var p=o-1,k;
p>=0;p--){k=t.url[p];n*=v[k]}if(n==c.DONE){t.success(t.url,this._loadTime)}else{var m=[];
for(var p=o-1,k;p>=0;p--){k=t.url[p];if(v[k]!=c.DONE){m.push(k)}}t.fail(m,this._loadTime)
}t.always(t.url,this._loadTime);return}},_detect:function(){var k=this;k._timerId=setInterval(function(){k._doDetect()
},k.cfg.pollingInterval)},load:function(){var l=this.cfg;this._loadTime=new Date().getTime();
if(l.url.length==0){l.success([],this._loadTime);l.always([],this._loadTime);return this
}if(l.cache){var p=[];e.each(l.url,function(r,s){if(e("link[href='"+s+"']").length==0){p.push(s)
}});if(p.length==0){l.success([],this._loadTime);l.always([],this._loadTime);return this
}else{l.url=p}}var k=this;var q=[];e.extend(q,l.url);var o=function(){k._loadCSS(q)
};for(var m,n=q.length-1;n>=0;n--){m=q[n];setTimeout(o,0)}k._detect();return this
},finalize:function(){var k=this.cfg;delete k.fail;delete k.success;delete k.always;
k=this.cfg=null;delete this._loadState}};function b(k){var o;if("string"==typeof k.url){k.url=[k.url]
}o=k.url;k.success=k.success||j;k.fail=k.fail||j;k.always=k.always||j;k.timeOut=k.timeOut||3;
k.pollingInterval=k.pollingInterval||20;k.ownerModule=k.ownerModule||"_";if("boolean"!=typeof k.cache){k.cache=true
}if(false===k.cache){var n=new Date().getTime();for(var m=o.length-1,l;m>=0;m--){l=o[m];
o[m]=f(l,"_="+n)}}return new c(k)}var d=/\/\/([^\/]+)/;function i(l){var m=location.host;
var n=(l||"").match(d);var k=false;if(n&&n[1]!=m){k=true}return k}function f(m,o,l){if(null==m||undefined==m){return m
}var n=m.split("#");var m=n[0];var k=(1==n.length)?"":"#"+n[1];n=m.split("?");n[1]=(1==n.length)?"?"+o:"?"+n[1]+"&"+o;
if(l&&l.length>0){k+=(""==k)?"#"+l:"&"+l}return n.join("")+k}return b});